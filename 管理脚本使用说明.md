# MD文件浏览器 - 管理脚本使用说明

## 快速开始

### 方式一：使用交互式管理脚本（推荐）⭐

```powershell
.\manage.ps1
```

这将启动一个带有友好界面的交互式管理工具，提供以下功能：

- 🚀 **启动服务** - 一键启动应用
- 🛑 **停止服务** - 安全停止运行中的服务  
- 🔄 **重启服务** - 快速重启应用
- 📊 **查看状态** - 实时查看运行状态、进程信息
- 📝 **查看日志** - 查看最近的运行日志
- 🔍 **实时监控** - 自动刷新的状态监控（每3秒）
- ⚙️ **刷新配置** - 重新加载配置文件
- 🌐 **浏览器打开** - 自动在浏览器中打开应用

### 方式二：使用传统脚本

#### 启动服务
```powershell
.\start.ps1
```

#### 重启服务
```powershell
.\restart.ps1
```

## 主要功能说明

### 🎯 交互式菜单

运行 `manage.ps1` 后，你会看到一个清晰的菜单界面：

```
╔═══════════════════════════════════════════════════════════════╗
║          MD文件浏览器 - 交互式管理界面                       ║
╚═══════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════
  服务状态
═══════════════════════════════════════════════════════════════

🟢 运行状态:    运行中
   • PID: 12345  |  启动时间: 2025-10-16 14:30:00

🌐 服务器地址:  0.0.0.0
🔌 监听端口:    8002
📁 扫描目录:    
   ✓ D:\show-md-file-v13\
   ✓ D:\mydata_D\

🔌 端口状态:    正在使用 (本应用)
🌍 访问地址:
   • 本地:    http://localhost:8002
   • 局域网:  http://192.168.1.100:8002

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  操作菜单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  [1] 启动服务
  [2] 停止服务
  [3] 重启服务
  [4] 查看状态
  [5] 查看日志
  [6] 实时监控
  [7] 刷新配置
  [8] 在浏览器中打开
  [9] 清理端口占用
  [0] 退出

请选择操作 [0-9]:
```

### 📊 状态监控

- **运行状态**：显示服务是否运行中（🟢 运行中 / 🔴 未运行）
- **进程信息**：显示进程ID (PID)、启动时间
- **资源使用**：在实时监控模式下显示CPU和内存使用情况
- **端口检测**：自动检测端口是否被占用
- **访问地址**：自动获取并显示本地和局域网访问地址

### 🔍 实时监控模式

选择 `[6] 实时监控` 进入实时监控模式：

- 每3秒自动刷新状态信息
- 显示详细的CPU和内存使用情况
- 按 `Ctrl+C` 返回主菜单
- 适合长时间监控服务运行状态

### 🛠️ 操作说明

#### 启动服务 [1]
- 检查服务是否已运行
- **智能端口占用处理**：
  - 自动检测端口是否被占用
  - 如果被占用，显示占用进程的详细信息（PID、进程名、路径）
  - 询问是否终止占用进程（输入 Y/N）
  - 自动清理后继续启动服务
- 启动Python应用
- 验证启动是否成功

**示例流程**：
```
🚀 正在启动服务...

⚠️  警告: 端口 8002 已被占用！

🔍 发现以下进程占用端口 8002:

   • PID: 12345  |  进程名: python
     路径: C:\Python\python.exe

❓ 是否要终止这些进程? [Y/N]: y

🔻 正在终止进程...
   终止进程 PID: 12345 (python)... ✅

⏳ 等待端口释放...
✅ 端口 8002 已释放 (终止了 1 个进程)

⏳ 等待服务启动...
✅ 服务启动成功！
```

#### 停止服务 [2]
- 查找所有相关的Python进程
- 安全终止所有进程
- 确认进程完全退出

#### 重启服务 [3]
- 先执行停止操作
- 等待进程完全退出
- 启动新的服务实例
- 一键完成整个重启流程

#### 查看日志 [5]
- 显示 `run.log` 文件的最近50行
- 方便排查问题

#### 刷新配置 [7]
- 重新读取 `env.ini` 配置文件
- 更新显示的配置信息
- 不会影响已运行的服务（需要重启服务才能应用新配置）

#### 在浏览器中打开 [8]
- 自动在默认浏览器中打开应用
- 无需手动输入地址

#### 清理端口占用 [9] 🆕
- 手动检查并清理指定端口的占用进程
- 显示所有占用端口的进程详细信息
- 询问确认后终止这些进程
- 适用于：
  - 端口被其他程序占用时
  - 想要在启动前清理端口
  - 服务异常退出但端口未释放

**使用场景**：
```
场景1: 启动服务前主动清理端口
  → 选择 [9] → 确认清理 → 选择 [1] 启动

场景2: 端口被其他程序占用
  → 选择 [9] → 查看占用进程 → 确认清理

场景3: 服务异常后端口未释放
  → 选择 [9] → 清理残留进程
```

## ⚙️ 配置文件

配置文件位于 `env.ini`，包含以下设置：

```ini
[settings]
# 要扫描的根目录路径（多个目录用逗号分隔）
scanfolder=D:\show-md-file-v13\,D:\mydata_D\

# 服务器监听端口
port=8002

# 服务器主机地址
host=0.0.0.0
```

修改配置后：
1. 在管理界面选择 `[7] 刷新配置` 查看新配置
2. 选择 `[3] 重启服务` 应用新配置

## 💡 使用技巧

### 快速启动
在项目目录右键，选择"在终端中打开"，然后运行：
```powershell
.\manage.ps1
```

### 创建桌面快捷方式
1. 右键 `manage.ps1` → 创建快捷方式
2. 右键快捷方式 → 属性
3. 目标改为：
   ```
   powershell.exe -ExecutionPolicy Bypass -File "D:\show-md-file-v13\manage.ps1"
   ```
4. 起始位置设为：`D:\show-md-file-v13\`
5. 将快捷方式移动到桌面

### 后台运行
如果希望服务在后台持续运行：
1. 使用管理脚本启动服务
2. 选择退出管理脚本（服务继续运行）
3. 需要管理时再次运行 `manage.ps1`

### 开机自启动
1. 按 `Win + R`，输入 `shell:startup`
2. 创建一个批处理文件 `启动MD浏览器.bat`：
   ```batch
   @echo off
   cd /d D:\show-md-file-v13
   powershell.exe -ExecutionPolicy Bypass -File ".\start.ps1"
   ```
3. 将批处理文件放入启动文件夹

## 🔧 故障排除

### 服务无法启动
1. 检查Python是否已安装：`python --version`
2. 检查依赖是否已安装：`pip install -r requirements.txt`
3. 检查端口是否被占用（管理脚本会自动检测）
4. 查看日志获取详细错误信息

### 无法访问服务
1. 确认服务已启动（状态显示为🟢运行中）
2. 检查防火墙设置
3. 确认端口配置正确
4. 尝试使用 `http://localhost:端口号` 访问

### 端口被占用

**推荐方案**（使用管理脚本）：
1. 运行 `manage.ps1`
2. 选择 `[9] 清理端口占用`
3. 或者直接选择 `[1] 启动服务`（会自动提示处理端口占用）

**手动方案**：
```powershell
# 查找占用端口的进程
netstat -ano | findstr :8002

# 终止进程（将PID替换为实际的进程ID）
taskkill /F /PID <PID>
```

### 进程无法终止
1. 以管理员身份运行PowerShell
2. 重新运行管理脚本
3. 尝试停止服务

## 📋 脚本对比

| 功能 | manage.ps1 | start.ps1 | restart.ps1 |
|------|------------|-----------|-------------|
| 交互式界面 | ✅ | ❌ | ❌ |
| 启动服务 | ✅ | ✅ | ✅ |
| 停止服务 | ✅ | ❌ | ✅ |
| 重启服务 | ✅ | ❌ | ✅ |
| 查看状态 | ✅ | ✅ | ✅ |
| 实时监控 | ✅ | ❌ | ❌ |
| 查看日志 | ✅ | ❌ | ❌ |
| 浏览器打开 | ✅ | ❌ | ❌ |
| **智能端口清理** | ✅ | ❌ | ❌ |
| **自动处理端口占用** | ✅ | ❌ | ❌ |
| 持续运行 | ✅ | ❌ | ❌ |

## 🎉 推荐使用

对于日常使用，强烈推荐使用 **`manage.ps1`** 交互式管理脚本，它提供了：

✅ 更直观的界面  
✅ 更多的功能  
✅ 更好的错误处理  
✅ 实时状态监控  
✅ **智能端口占用处理** 🆕  
✅ **自动清理冲突进程** 🆕  
✅ 一站式管理体验  

---

**祝使用愉快！** 🎊

如有问题或建议，欢迎反馈。

